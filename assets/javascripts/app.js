// Generated by CoffeeScript 1.4.0
(function() {
  var AreaSummary, CustomInfoWindow,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  window.LANG = (function() {
    var hash, match, regex;
    hash = window.location.hash;
    regex = /^#\/*(en|fr)\/*/;
    match = regex.exec(hash);
    if (match) {
      return match[1];
    } else {
      return "en";
    }
  })();

  window.LOCAL_STORAGE = (function() {
    if (window['localStorage'] != null) {
      return true;
    } else {
      return false;
    }
  })();

  Cartographer.initiate = function() {
    var _this = this;
    $('.close-notice').click(function(e) {
      return $(e.target).closest('#notice').hide();
    });
    this.templates = new Cartographer.TemplatesLoader();
    $('#notice .close').click(function() {
      return $(this).closest('#notice').hide();
    });
    return this.templates.loadDefaults(function() {
      return _this.currentMap = new Cartographer.CustomMap('#map', {
        "onLoad": function(context) {
          return _this.mapHasLoaded(context);
        }
      });
    });
  };

  Cartographer.mapHasLoaded = function(context) {
    if (!(this.currentMap != null)) {
      this.currentMap = context;
    }
    return this.router = new Cartographer.router();
  };

  Cartographer.switchLang = function(lang) {
    var url;
    if (window.LANG !== lang) {
      url = "http://" + window.location.hostname + "/" + window.location.hash;
      window.location = url;
      return window.location.reload(true);
    }
  };

  Cartographer.highlighMarker = function(target) {
    if (_.isObject(target)) {
      return this.currentMap.panToCoord(target);
    } else {
      return this.currentMap.panToMarker(target);
    }
  };

  Cartographer.toggleCat = function(cats) {
    return this.currentMap.highlightsCat(cats);
  };

  Cartographer.showInfo = function() {
    var content, modal;
    modal = new Cartographer.Modalbox("info");
    content = "<h1>Hey there fellow explorers!</h1>\n<p class=\"big\">Welcome to gw2cartographers, a Guildwars 2 interactive map. This map is 100% crowdsourced! So if you want to add / edit / remove some points, here is how:</p>\n<h2>Adding points</h2>\n<p>Simply click on the «+» next to the desired point label inside the drop down menu</p>";
    modal.setContent(content);
    return modal.open();
  };

  /*
  # class Cartographer.TemplatesLoader {{{
  */


  Cartographer.TemplatesLoader = (function() {

    function TemplatesLoader() {
      this.templates = {
        "confirmBox": {
          name: "confirmBox",
          path: "assets/javascripts/templates/confirmBox._",
          version: 1,
          src: "",
          loadOnStart: true
        },
        "customInfoWindow": {
          name: "customInfoWindow",
          path: "assets/javascripts/templates/customInfoWindow._",
          version: 3,
          src: "",
          loadOnStart: true
        },
        "markersOptions": {
          name: "markersOptions",
          path: "assets/javascripts/templates/markersOptions._",
          version: 4,
          src: "",
          loadOnStart: true
        },
        "areasSummary": {
          name: "areasSummary",
          path: "assets/javascripts/templates/areasSummary._",
          version: 1,
          src: "",
          loadOnStart: true
        }
      };
    }

    TemplatesLoader.prototype.get = function(templateName, callback) {
      var handleCallback, localTemplate, localTemplateVersion,
        _this = this;
      handleCallback = function(template) {
        if (callback != null) {
          return callback(template);
        } else {
          return retu;
        }
      };
      if (LOCAL_STORAGE) {
        localTemplate = localStorage.getItem(templateName);
        localTemplateVersion = localStorage.getItem("" + templateName + "Version");
        if ((this.templates[templateName] != null) && this.templates[templateName].src !== "") {
          if (callback != null) {
            return callback(this.templates[templateName].src);
          } else {
            return this.templates[templateName].src;
          }
        } else if (localTemplate && ((localTemplateVersion != null) && parseInt(localTemplateVersion) === this.templates[templateName].version)) {
          this.templates[templateName].src = localTemplate;
          if (callback != null) {
            return callback(localTemplate);
          } else {
            return localTemplate;
          }
        } else if (this.templates[templateName] != null) {
          return $.get(this.templates[templateName].path, function(e) {
            localStorage.setItem(templateName, e);
            _this.templates[templateName].src = e;
            localStorage.setItem("" + templateName + "Version", _this.templates[templateName].version);
            return callback(e);
          });
        }
      } else {
        return $.get(this.templates[templateName].path, function(e) {
          return callback(e);
        });
      }
    };

    TemplatesLoader.prototype.loadDefaults = function(callback) {
      var templateToLoad,
        _this = this;
      templateToLoad = _.filter(this.templates, function(template, name) {
        return template.loadOnStart;
      });
      this.queue = templateToLoad.length;
      return _.each(templateToLoad, function(template, name) {
        return _this.get(template.name, function() {
          _this.queue--;
          if (_this.queue === 0) {
            return callback();
          }
        });
      });
    };

    return TemplatesLoader;

  })();

  /*
  #}}}
  */


  /*
  # class Cartographer.ModalBox {{{
  */


  Cartographer.Modalbox = (function() {

    function Modalbox(idModal) {
      this.close = __bind(this.close, this);
      if (_.isString(idModal)) {
        idModal = ' id="' + idModal + '"';
      } else {
        idModal = "";
      }
      this.modal = $('<div class="modal"' + idModal + '><div class="padding"></div></div>');
      this.overlay = $('<span class="overlay"></span>');
      $('body').append(this.modal);
      $('body').append(this.overlay);
      this.overlay.bind('click', this.close);
    }

    Modalbox.prototype.open = function() {
      this.modal.addClass('visible');
      return this.overlay.addClass('visible');
    };

    Modalbox.prototype.close = function(callback) {
      var t,
        _this = this;
      callback = _.isFunction(callback) ? callback : function() {};
      this.modal.addClass('fadding');
      this.overlay.addClass('fadding');
      return t = setTimeout(function() {
        _this.modal.removeClass('visible fadding');
        _this.overlay.removeClass('visible fadding');
        return callback();
      }, 150);
    };

    Modalbox.prototype.setContent = function(content) {
      return this.modal.find('.padding').html(content);
    };

    return Modalbox;

  })();

  /*
  #}}}
  */


  /*
  # class Cartographer.Confirmbox {{{
  */


  Cartographer.Confirmbox = (function(_super) {

    __extends(Confirmbox, _super);

    function Confirmbox(template) {
      Confirmbox.__super__.constructor.apply(this, arguments);
      this.modal.addClass('confirm-box');
      this.template = template;
      this.overlay.unbind('click');
    }

    Confirmbox.prototype.initConfirmation = function(contentString, callback) {
      var acceptBtn, confirmBoxContent, confirmMessage, deniedBtn,
        _this = this;
      confirmMessage = {
        confirmMessage: contentString
      };
      confirmBoxContent = $(this.template(confirmMessage));
      acceptBtn = confirmBoxContent.find('#accept');
      deniedBtn = confirmBoxContent.find('#denied');
      this.modal.find('.padding').html(confirmBoxContent);
      acceptBtn.bind('click', function() {
        callback(true);
        return _this.close();
      });
      deniedBtn.bind('click', function() {
        callback(false);
        return _this.close();
      });
      return this.open();
    };

    return Confirmbox;

  })(Cartographer.Modalbox);

  /*
  #}}}
  */


  /*
  # class Cartographer.CustomMap {{{
  */


  Cartographer.CustomMap = (function() {

    function CustomMap(HTMLMapWrapperID, opts) {
      this.handleAddTool = __bind(this.handleAddTool, this);

      this.handleExport = __bind(this.handleExport, this);

      this.sendMapForApproval = __bind(this.sendMapForApproval, this);

      this.destroyLocalStorage = __bind(this.destroyLocalStorage, this);

      this.createInfoWindow = __bind(this.createInfoWindow, this);

      var confirmBoxTemplate,
        _this = this;
      this.markersOptionsMenu = $('#markers-options');
      this.startLat = 15.443090823463786;
      this.startLng = 7.294921875;
      this.defaultCat = "explore";
      this.localStorageKey = "gw2c_markers_config_01";
      this.blankTilePath = 'tiles/00empty.jpg';
      this.areaSummaryBoxes = [];
      this.markersImages = {};
      this.mapMarkersObject = {};
      this.draggableMarker = false;
      this.visibleMarkers = true;
      this.canToggleMarkers = true;
      this.currentOpenedInfoWindow = false;
      this.activeArea = null;
      this.currentMapVersion = 1;
      this.initCustomMap("map");
      this.editInfoWindowTemplate = _.template(Cartographer.templates.get("customInfoWindow"));
      confirmBoxTemplate = _.template(Cartographer.templates.get("confirmBox"));
      this.confirmBox = new Cartographer.Confirmbox(confirmBoxTemplate);
      this.handleLocalStorageLoad(function() {
        _this.initializeAreaSummaryBoxes();
        _this.setAllMarkers();
        _this.hideMarkersOptionsMenu();
        _this.bindMapEvents();
        _this.addMenuIcons();
        _this.addTools = $('.menu-marker a.add');
        _this.addTools.each(function(index, target) {
          return $(target).bind('click', _this.handleAddTool);
        });
        $('#destroy').bind('click', _this.destroyLocalStorage);
        return opts.onLoad(_this);
      });
    }

    CustomMap.prototype.bindMapEvents = function() {
      var _this = this;
      this.map.on('zoomend', function(e) {
        var zoomLevel;
        zoomLevel = e.target._zoom;
        if (zoomLevel === 4) {
          _this.hideMarkersOptionsMenu();
          return $('#map .leaflet-objects-pane').removeClass('off');
        } else if (zoomLevel > 4) {
          _this.showMarkersOptionsMenu();
          return $('#map .leaflet-objects-pane').removeClass('off');
        } else if (zoomLevel < 4) {
          _this.hideMarkersOptionsMenu();
          return $('#map .leaflet-objects-pane').addClass('off');
        }
      });
      return $("#options-toggle").click(function() {
        var parent;
        parent = $(this).closest('#markers-options');
        return parent.toggleClass('active');
      });
    };

    CustomMap.prototype.highlightMarker = function(marker) {
      if (this.currentOpenedInfoWindow) {
        this.currentOpenedInfoWindow.close();
      }
      marker.setVisible(true);
      if (!(marker.infoWindow != null)) {
        this.createInfoWindow(marker);
        this.currentOpenedInfoWindow = marker.infoWindow;
        return marker.infoWindow.open();
      } else {
        marker.infoWindow.open();
        return this.currentOpenedInfoWindow = marker.infoWindow;
      }
    };

    CustomMap.prototype.panToCoord = function(coord) {
      var marker, markerType, markerTypeObject, markersCat, markersObjects, _ref, _results;
      _ref = this.mapMarkersObject;
      _results = [];
      for (markersCat in _ref) {
        markersObjects = _ref[markersCat];
        _results.push((function() {
          var _ref1, _results1;
          _ref1 = markersObjects.marker_types;
          _results1 = [];
          for (markerType in _ref1) {
            markerTypeObject = _ref1[markerType];
            _results1.push((function() {
              var _i, _len, _ref2, _results2;
              _ref2 = markerTypeObject.markers;
              _results2 = [];
              for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
                marker = _ref2[_i];
                if (coord.lat === marker.position.lat().toString() && coord.lng === marker.position.lng().toString()) {
                  _results2.push(marker.trigger('click', ['test']));
                } else {
                  _results2.push(void 0);
                }
              }
              return _results2;
            })());
          }
          return _results1;
        })());
      }
      return _results;
    };

    CustomMap.prototype.panToMarker = function(markerId) {
      var clickOnMarker, marker, markerType, markerTypeObject, markersCat, markersObjects, _ref, _results,
        _this = this;
      clickOnMarker = function(marker) {
        var t, time;
        time = 0;
        if ((marker.area != null) && marker.area !== _this.activeArea) {
          marker.area.areaSummary.setActive();
          time = 1000;
        }
        return t = setTimeout(function() {
          return marker.fire('click', {
            'src': 'url'
          });
        }, time);
      };
      _ref = this.mapMarkersObject;
      _results = [];
      for (markersCat in _ref) {
        markersObjects = _ref[markersCat];
        _results.push((function() {
          var _ref1, _results1;
          _ref1 = markersObjects.marker_types;
          _results1 = [];
          for (markerType in _ref1) {
            markerTypeObject = _ref1[markerType];
            _results1.push((function() {
              var _i, _len, _ref2, _results2;
              _ref2 = markerTypeObject.markers;
              _results2 = [];
              for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
                marker = _ref2[_i];
                if (parseInt(markerId) === marker.id_marker) {
                  _results2.push(clickOnMarker(marker));
                } else {
                  _results2.push(void 0);
                }
              }
              return _results2;
            })());
          }
          return _results1;
        })());
      }
      return _results;
    };

    CustomMap.prototype.initCustomMap = function(wrap) {
      var layer, tileUrl;
      this.map = new L.Map(wrap, {
        center: new L.LatLng(10.044584984211879, 10.3271484375),
        zoom: 4,
        maxZoom: 7,
        minZoom: 3
      });
      tileUrl = 'tiles/{z}_{x}_{y}.jpg';
      layer = new L.TileLayer(tileUrl, {
        maxZoom: 7
      });
      return this.map.addLayer(layer);
    };

    CustomMap.prototype.handleLocalStorageLoad = function(callback) {
      var confirmMessage,
        _this = this;
      if (window.LOCAL_STORAGE && this.getConfigFromLocalStorage()) {
        confirmMessage = Traduction["notice"]["localDetected"][LANG];
        return this.confirmBox.initConfirmation(confirmMessage, function(e) {
          var loadedConfig;
          if (e) {
            loadedConfig = _this.getConfigFromLocalStorage();
            _this.MarkersConfig = loadedConfig.markers;
          } else {
            _this.MarkersConfig = Markers;
          }
          return callback();
        });
      } else {
        this.MarkersConfig = Markers;
        return callback();
      }
    };

    CustomMap.prototype.getConfigFromLocalStorage = function() {
      var json;
      json = localStorage.getItem(this.localStorageKey);
      return JSON.parse(json);
    };

    CustomMap.prototype.addMarker = function(markerInfo, otherInfo, isNew, defaultValue) {
      var area, iconPath, iconmid, iconsize, idArea, image, isMarkerDraggable, latLng, marker, markerTitle, markerVisibility, markersCat, markersType, options, _ref,
        _this = this;
      latLng = new L.LatLng(markerInfo.lat, markerInfo.lng);
      iconsize = 32;
      iconmid = iconsize / 2;
      iconPath = Metadata.icons_path + otherInfo.icon;
      markersType = otherInfo["markersType"];
      markersCat = otherInfo["markersCat"];
      markerVisibility = markersCat === isNew ? true : false;
      if (!(this.markersImages[markersType] != null)) {
        image = new L.icon({
          iconUrl: iconPath,
          iconSize: [iconsize, iconsize],
          iconAnchor: [iconmid, iconmid],
          popupAnchor: [iconmid, iconmid]
        });
        this.markersImages[markersType] = image;
      }
      isMarkerDraggable = markerInfo.draggable != null ? markerInfo.draggable : false;
      if (defaultValue != null) {
        markerTitle = defaultValue[LANG]["title"] || defaultValue[LANG]["name"];
      } else {
        markerTitle = markerInfo["data_translation"][LANG]["title"];
      }
      options = {
        draggable: isMarkerDraggable,
        clickable: true,
        icon: this.markersImages[markersType],
        title: markerTitle
      };
      marker = new L.Marker(latLng, options);
      if (defaultValue != null) {
        marker["data_translation"] = defaultValue;
        marker["hasDefaultValue"] = true;
      } else {
        marker["data_translation"] = markerInfo["data_translation"];
        marker["hasDefaultValue"] = false;
      }
      marker["id_marker"] = markerInfo["id"];
      marker["uniqueID"] = _.uniqueId();
      marker["type"] = markersType;
      marker["cat"] = markersCat;
      marker["map"] = this.map;
      _ref = this.areas;
      for (idArea in _ref) {
        area = _ref[idArea];
        if (marker._latlng.lat <= area.neLat && marker._latlng.lat >= area.swLat && marker._latlng.lng <= area.neLng && marker._latlng.lng >= area.swLng) {
          marker["area"] = area;
        }
      }
      marker.on('click', function(e) {
        var lang;
        if (marker.id_marker.toString() !== "-1" && !(e.src != null)) {
          lang = window.LANG === "en" ? "" : "fr/";
          return window.location.hash = "/" + lang + "show/" + marker.id_marker + "/";
        } else {
          if (e.target.popUp != null) {
            return e.target.popUp.open();
          } else {
            return _this.createInfoWindow(e.target);
          }
        }
      });
      marker.on('dragend', function(e) {
        _this.saveToLocalStorage();
        if (e.target.popUp) {
          return e.target.popUp.setLatLng(new L.LatLng(marker._latlng.lat, marker._latlng.lng));
        }
      });
      if (markerVisibility) {
        marker.addTo(this.map);
      }
      return marker;
    };

    CustomMap.prototype.createInfoWindow = function(marker) {
      var editInfoWindowContent, lang, templateInfo,
        _this = this;
      lang = window.LANG === "en" ? "#/" : "#/fr/";
      templateInfo = {
        id: marker.uniqueID,
        title: (function() {
          if (marker["data_translation"][LANG]["title"] || marker["data_translation"][LANG]["name"]) {
            return marker["data_translation"][LANG]["title"] || marker["data_translation"][LANG]["name"];
          } else if (marker.type === "vistas" || marker.type === "skillpoints") {
            return Traduction["infoWindow"][marker.type][LANG];
          } else {
            return "";
          }
        })(),
        desc: marker["data_translation"][LANG]["desc"],
        wikiLink: marker["data_translation"][LANG]["link_wiki"] || "",
        hasDefaultValue: marker["hasDefaultValue"],
        type: marker.type,
        lat: marker._latlng.lat,
        lng: marker._latlng.lng,
        shareLink: "http://" + window.location.hostname + "/" + lang + "show/" + marker.id_marker + "/"
      };
      editInfoWindowContent = this.editInfoWindowTemplate(templateInfo);
      return marker["popUp"] = new CustomInfoWindow(marker, editInfoWindowContent, {
        onSave: function(newInfo) {
          return _this.updateMarkerInfos(newInfo);
        },
        deleteCalled: function(marker) {
          return _this.removeMarker(marker.uniqueID, marker.type, marker.cat);
        },
        moveCalled: function(marker) {
          if (marker.dragging.enabled()) {
            return marker.dragging.disable();
          } else {
            return marker.dragging.enable();
          }
        },
        template: this.editInfoWindowTemplate
      });
    };

    CustomMap.prototype.setAllMarkers = function() {
      var defaultValue, marker, markerType, markerTypeObject, markersCat, markersObjects, newMarker, otherInfo, _ref, _results;
      this.currentMapVersion = Metadata.version;
      _ref = this.MarkersConfig;
      _results = [];
      for (markersCat in _ref) {
        markersObjects = _ref[markersCat];
        if (!(this.mapMarkersObject[markersCat] != null)) {
          this.mapMarkersObject[markersCat] = {};
          this.mapMarkersObject[markersCat]["data_translation"] = markersObjects.data_translation;
          this.mapMarkersObject[markersCat]["marker_types"] = {};
        }
        _results.push((function() {
          var _ref1, _results1;
          _ref1 = markersObjects.marker_types;
          _results1 = [];
          for (markerType in _ref1) {
            markerTypeObject = _ref1[markerType];
            this.mapMarkersObject[markersCat]["marker_types"][markerType] = $.extend(true, {}, markerTypeObject);
            this.mapMarkersObject[markersCat]["marker_types"][markerType]["markers"] = [];
            otherInfo = {
              markersCat: markersCat,
              markersType: markerType,
              icon: markerTypeObject.icon
            };
            defaultValue = null;
            if ((markerTypeObject["data_translation"][LANG]["title"] != null) && (markerTypeObject["data_translation"][LANG]["desc"] != null)) {
              defaultValue = markerTypeObject["data_translation"];
            }
            _results1.push((function() {
              var _i, _len, _ref2, _results2;
              _ref2 = markerTypeObject.markers;
              _results2 = [];
              for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
                marker = _ref2[_i];
                newMarker = this.addMarker(marker, otherInfo, false, defaultValue);
                _results2.push(this.mapMarkersObject[markersCat]["marker_types"][markerType]["markers"].push(newMarker));
              }
              return _results2;
            }).call(this));
          }
          return _results1;
        }).call(this));
      }
      return _results;
    };

    CustomMap.prototype.showMarkerFromArea = function(areaId) {
      var cat, lat, lng, marker, markerType, markerTypeObject, markersObjects, _ref, _results;
      if (this.activeArea) {
        this.activeArea.areaSummary.setInactive();
      }
      this.activeArea = this.areas[areaId];
      _ref = this.mapMarkersObject;
      _results = [];
      for (cat in _ref) {
        markersObjects = _ref[cat];
        _results.push((function() {
          var _ref1, _results1;
          _ref1 = markersObjects.marker_types;
          _results1 = [];
          for (markerType in _ref1) {
            markerTypeObject = _ref1[markerType];
            if (!$("[data-type='" + markerType + "']").hasClass('off')) {
              _results1.push((function() {
                var _i, _len, _ref2, _results2;
                _ref2 = markerTypeObject["markers"];
                _results2 = [];
                for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
                  marker = _ref2[_i];
                  if (!(marker != null)) {
                    continue;
                  }
                  lat = marker.getLatLng().lat;
                  lng = marker.getLatLng().lng;
                  if (lat <= this.activeArea.neLat && lat >= this.activeArea.swLat && lng <= this.activeArea.neLng && lng >= this.activeArea.swLng) {
                    _results2.push(marker.addTo(this.map));
                  } else {
                    this.map.removeLayer(marker);
                    if (marker["popUp"]) {
                      _results2.push(this.map.removeLayer(marker["popUp"]));
                    } else {
                      _results2.push(void 0);
                    }
                  }
                }
                return _results2;
              }).call(this));
            }
          }
          return _results1;
        }).call(this));
      }
      return _results;
    };

    CustomMap.prototype.setAllMarkersVisibility = function(isVisible) {
      var cat, markerType, markerTypeObject, markersObjects, _ref, _results;
      _ref = this.mapMarkersObject;
      _results = [];
      for (cat in _ref) {
        markersObjects = _ref[cat];
        _results.push((function() {
          var _ref1, _results1;
          _ref1 = markersObjects.marker_types;
          _results1 = [];
          for (markerType in _ref1) {
            markerTypeObject = _ref1[markerType];
            if (!$("[data-type='" + markerType + "']").hasClass('off')) {
              _results1.push(this.setMarkersVisibilityByType(isVisible, markerType, cat));
            }
          }
          return _results1;
        }).call(this));
      }
      return _results;
    };

    CustomMap.prototype.setMarkersVisibilityByType = function(isVisible, type, cat) {
      var lat, lng, marker, _i, _len, _ref, _results;
      _ref = this.mapMarkersObject[cat]["marker_types"][type]["markers"];
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        marker = _ref[_i];
        if (!(marker != null)) {
          continue;
        }
        if (marker.popUp != null) {
          this.map.removeLayer(marker.popUp);
        }
        lat = marker.getLatLng().lat;
        lng = marker.getLatLng().lng;
        if (isVisible && (marker != null) && lat <= this.activeArea.neLat && lat >= this.activeArea.swLat && lng <= this.activeArea.neLng && lng >= this.activeArea.swLng) {
          if (!(marker._map != null)) {
            _results.push(marker.addTo(this.map));
          } else {
            _results.push(void 0);
          }
        } else {
          if (marker._map != null) {
            _results.push(this.map.removeLayer(marker));
          } else {
            _results.push(void 0);
          }
        }
      }
      return _results;
    };

    CustomMap.prototype.setMarkersVisibilityByCat = function(isVisible, cat) {
      var lat, lng, marker, markerType, markerTypeObject, _ref, _results;
      _ref = this.mapMarkersObject[cat]["marker_types"];
      _results = [];
      for (markerType in _ref) {
        markerTypeObject = _ref[markerType];
        _results.push((function() {
          var _i, _len, _ref1, _results1;
          _ref1 = markerTypeObject.markers;
          _results1 = [];
          for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
            marker = _ref1[_i];
            if (marker.popUp != null) {
              this.map.removeLayer(marker.popUp);
            }
            lat = marker.getLatLng().lat;
            lng = marker.getLatLng().lng;
            if (isVisible && lat <= this.activeArea.neLat && lat >= this.activeArea.swLat && lng <= this.activeArea.neLng && lng >= this.activeArea.swLng) {
              if (!(marker._map != null)) {
                _results1.push(marker.addTo(this.map));
              } else {
                _results1.push(void 0);
              }
            } else {
              if (marker._map != null) {
                _results1.push(this.map.removeLayer(marker));
              } else {
                _results1.push(void 0);
              }
            }
          }
          return _results1;
        }).call(this));
      }
      return _results;
    };

    CustomMap.prototype.highlightsCat = function(cats) {
      var cat, markerCat, markerCatObject, _ref, _results;
      _ref = this.mapMarkersObject;
      _results = [];
      for (markerCat in _ref) {
        markerCatObject = _ref[markerCat];
        this.setMarkersVisibilityByCat(false, markerCat);
        this.turnOffMenuIconsFromCat(markerCat);
        _results.push((function() {
          var _i, _len, _results1;
          _results1 = [];
          for (_i = 0, _len = cats.length; _i < _len; _i++) {
            cat = cats[_i];
            if (!(markerCat === cat)) {
              continue;
            }
            this.turnOnMenuIconsFromCat(cat);
            if (this.canToggleMarkers === true) {
              _results1.push(this.setMarkersVisibilityByCat(true, cat));
            } else {
              _results1.push(void 0);
            }
          }
          return _results1;
        }).call(this));
      }
      return _results;
    };

    CustomMap.prototype.destroyLocalStorage = function(e) {
      var confirmMessage,
        _this = this;
      confirmMessage = Traduction["notice"]["dataDestruction"][LANG];
      return this.confirmBox.initConfirmation(confirmMessage, function(e) {
        if (e && _this.getConfigFromLocalStorage()) {
          localStorage.removeItem(_this.localStorageKey);
          return window.location = "/";
        }
      });
    };

    CustomMap.prototype.sendMapForApproval = function(e) {
      var ajaxUrl, confirmMessage, modal, this_,
        _this = this;
      this_ = $(e.currentTarget);
      ajaxUrl = this_.attr('data-ajaxUrl');
      modal = new Cartographer.Modalbox("waiting");
      confirmMessage = Traduction["notice"]["dataApproval"][LANG];
      return this.confirmBox.initConfirmation(confirmMessage, function(e) {
        var request;
        if (e === true) {
          modal.setContent('<h1 text-align: center;>Please wait while your request is being handled.</h1><img class="loading" src="/assets/images/loading-black.gif"><p style="text-align: center;">This could take a few seconds</p>');
          modal.open();
          return request = $.ajax({
            url: ajaxUrl,
            type: "POST",
            dataType: 'json',
            crossDomain: true,
            data: {
              "json": _this.handleExport()
            },
            beforeSend: function(x) {
              if (x && x.overrideMimeType) {
                return x.overrideMimeType("application/json;charset=UTF-8");
              }
            },
            success: function(result) {
              if (result.success === true) {
                localStorage.removeItem(_this.localStorageKey);
              }
              modal.setContent(result.message);
              return modal.open();
            }
          });
        }
      });
    };

    CustomMap.prototype.handleExport = function(e) {
      var exportMarkerObject, finalExport, jsonString, marker, markerType, markerTypeObject, markersCat, markersObjects, nm, _i, _len, _ref, _ref1, _ref2;
      exportMarkerObject = {};
      _ref = this.mapMarkersObject;
      for (markersCat in _ref) {
        markersObjects = _ref[markersCat];
        if (!(exportMarkerObject[markersCat] != null)) {
          exportMarkerObject[markersCat] = {};
          exportMarkerObject[markersCat]["data_translation"] = markersObjects["data_translation"];
          exportMarkerObject[markersCat]["marker_types"] = {};
        }
        _ref1 = markersObjects.marker_types;
        for (markerType in _ref1) {
          markerTypeObject = _ref1[markerType];
          exportMarkerObject[markersCat]["marker_types"][markerType] = $.extend(true, {}, markerTypeObject);
          exportMarkerObject[markersCat]["marker_types"][markerType]["markers"] = [];
          _ref2 = markerTypeObject.markers;
          for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
            marker = _ref2[_i];
            if (marker["data_translation"] != null) {
              nm = {
                "lng": marker._latlng.lng,
                "lat": marker._latlng.lat,
                "data_translation": $.extend(true, {}, marker["data_translation"])
              };
            } else {
              nm = {
                "lng": marker._latlng.lng,
                "lat": marker._latlng.lat
              };
            }
            exportMarkerObject[markersCat]["marker_types"][markerType]["markers"].push(nm);
            nm["id"] = marker["id_marker"];
          }
        }
      }
      finalExport = {};
      finalExport["version"] = this.currentMapVersion;
      finalExport["creation_date"] = "null";
      finalExport["markers"] = exportMarkerObject;
      jsonString = JSON.stringify(finalExport);
      return jsonString;
    };

    CustomMap.prototype.handleAddTool = function(e) {
      var coord, defaultValue, getValue, icon, markerCat, markerLink, markerType, newMarker, newMarkerInfo, otherInfo, parent, this_,
        _this = this;
      this_ = $(e.currentTarget);
      parent = this_.closest('.type-menu-item');
      markerLink = parent.find('.marker-type-link');
      markerType = markerLink.attr('data-type');
      markerCat = markerLink.attr('data-cat');
      icon = markerLink.attr('data-icon');
      coord = this.map.getCenter();
      getValue = function(cat, type) {
        var defaultDesc, defaultTitle, defaultValue;
        defaultValue = null;
        defaultDesc = _this.MarkersConfig[cat]["marker_types"][type]["data_translation"][LANG]["desc"];
        defaultTitle = _this.MarkersConfig[cat]["marker_types"][type]["data_translation"][LANG]["title"] || _this.MarkersConfig[cat]["marker_types"][type]["data_translation"][LANG]["name"];
        if (((defaultDesc != null) || defaultTitle === "") && (defaultTitle != null)) {
          defaultValue = $.extend(true, {}, _this.MarkersConfig[cat]["marker_types"][type]["data_translation"]);
        }
        return defaultValue;
      };
      defaultValue = getValue(markerCat, markerType);
      otherInfo = {
        markersCat: markerCat,
        markersType: markerType,
        icon: icon
      };
      if (defaultValue) {
        newMarkerInfo = {
          id: -1,
          lat: coord.lat,
          lng: coord.lng,
          draggable: true
        };
      } else {
        newMarkerInfo = {
          id: -1,
          lat: coord.lat,
          lng: coord.lng,
          data_translation: {
            en: {
              title: "",
              desc: "",
              wikiLink: ""
            },
            fr: {
              title: "",
              desc: "",
              wikiLink: ""
            }
          },
          draggable: true
        };
      }
      newMarker = this.addMarker(newMarkerInfo, otherInfo, true, defaultValue);
      this.map.addLayer(newMarker);
      console.log(this.mapMarkersObject);
      return this.mapMarkersObject[markerCat]["marker_types"][markerType]["markers"].push(newMarker);
    };

    CustomMap.prototype.removeMarker = function(id, mType, mCat) {
      var confirmMessage,
        _this = this;
      confirmMessage = Traduction["notice"]["deleteMarker"][LANG];
      return this.confirmBox.initConfirmation(confirmMessage, function(e) {
        var marker, markerKey, _i, _len, _ref;
        if (e) {
          _ref = _this.mapMarkersObject[mCat]["marker_types"][mType]["markers"];
          for (markerKey = _i = 0, _len = _ref.length; _i < _len; markerKey = ++_i) {
            marker = _ref[markerKey];
            if (!(marker.uniqueID === id)) {
              continue;
            }
            if (marker.popUp != null) {
              _this.map.removeLayer(marker.popUp);
            }
            _this.map.removeLayer(marker);
            _this.mapMarkersObject[mCat]["marker_types"][mType]['markers'] = _.reject(_this.mapMarkersObject[mCat]["marker_types"][mType]["markers"], function(m) {
              return m === marker;
            });
            _this.saveToLocalStorage();
            return true;
          }
        }
      });
    };

    CustomMap.prototype.updateMarkerInfos = function(newInfo) {
      var marker, markerKey, _i, _len, _ref;
      _ref = this.mapMarkersObject[newInfo.cat]["marker_types"][newInfo.type]["markers"];
      for (markerKey = _i = 0, _len = _ref.length; _i < _len; markerKey = ++_i) {
        marker = _ref[markerKey];
        if (!(marker.uniqueID === newInfo.id)) {
          continue;
        }
        console.log(marker);
        if (marker["data_translation"] != null) {
          marker["data_translation"][LANG]["desc"] = newInfo.desc;
          marker["data_translation"][LANG]["title"] = newInfo.title;
          marker["data_translation"][LANG]["link_wiki"] = newInfo.wikiLink;
        } else {
          marker.desc = newInfo.desc;
          marker.title = newInfo.title;
          marker.wikiLink = newInfo.wikiLink;
        }
        this.saveToLocalStorage();
        return;
      }
    };

    CustomMap.prototype.saveToLocalStorage = function() {
      var json;
      if (window.LOCAL_STORAGE) {
        json = this.handleExport();
        return localStorage.setItem(this.localStorageKey, json);
      }
    };

    CustomMap.prototype.getMarkerByCoordinates = function(lat, lng) {
      var key, marker, markerTypeObject, markersCat, markersObjects, _i, _j, _len, _len1, _ref, _ref1, _ref2;
      _ref = this.MarkersConfig;
      for (markersCat in _ref) {
        markersObjects = _ref[markersCat];
        _ref1 = markersObjects.marker_types;
        for (key = _i = 0, _len = _ref1.length; _i < _len; key = ++_i) {
          markerTypeObject = _ref1[key];
          _ref2 = markerTypeObject.markers;
          for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {
            marker = _ref2[_j];
            if (marker.lat === lat && marker.lng === lng) {
              return marker;
            }
          }
        }
      }
      return false;
    };

    CustomMap.prototype.turnOffMenuIconsFromCat = function(markerCat) {
      var menu;
      menu = $(".menu-item[data-markerCat='" + markerCat + "']");
      menu.addClass('off');
      menu.find('.group-toggling').addClass('off');
      return menu.find('.trigger').addClass('off');
    };

    CustomMap.prototype.turnOnMenuIconsFromCat = function(markerCat) {
      var menu;
      menu = $(".menu-item[data-markerCat='" + markerCat + "']");
      menu.removeClass('off');
      menu.find('.group-toggling').removeClass('off');
      return menu.find('.trigger').removeClass('off');
    };

    CustomMap.prototype.addMenuIcons = function() {
      var html, markerCat, template, _results,
        _this = this;
      template = _.template(Cartographer.templates.get("markersOptions"));
      html = $(template(this.MarkersConfig));
      html.find(".trigger").bind('click', function(e) {
        var item, markerCat, markerType, myGroupTrigger, myMenuItem;
        if (_this.activeArea) {
          item = $(e.currentTarget);
          myGroupTrigger = item.closest(".menu-marker").find('.group-toggling');
          myMenuItem = item.closest(".menu-item");
          markerType = item.attr('data-type');
          markerCat = item.attr('data-cat');
          if (_this.canToggleMarkers) {
            if (item.hasClass('off')) {
              _this.setMarkersVisibilityByType(true, markerType, markerCat);
              item.removeClass('off');
              myMenuItem.removeClass('off');
              return myGroupTrigger.removeClass('off');
            } else {
              _this.setMarkersVisibilityByType(false, markerType, markerCat);
              return item.addClass('off');
            }
          }
        }
      });
      html.find('.group-toggling').bind('click', function(e) {
        var markerCat, menuItem, this_;
        if (_this.activeArea) {
          this_ = $(e.currentTarget);
          menuItem = this_.closest('.menu-item');
          markerCat = menuItem.attr('data-markerCat');
          if (this_.hasClass('off')) {
            this_.removeClass('off');
            menuItem.removeClass('off');
            _this.setMarkersVisibilityByCat(true, markerCat);
            return menuItem.find('.trigger').removeClass('off');
          } else {
            this_.addClass('off');
            menuItem.addClass('off');
            _this.setMarkersVisibilityByCat(false, markerCat);
            return menuItem.find('.trigger').addClass('off');
          }
        }
      });
      this.markersOptionsMenu.find('.padding').prepend(html);
      _results = [];
      for (markerCat in this.MarkersConfig) {
        if (markerCat !== this.defaultCat) {
          _results.push(this.turnOffMenuIconsFromCat(markerCat));
        }
      }
      return _results;
    };

    CustomMap.prototype.initializeAreaSummaryBoxes = function() {
      var _this = this;
      this.areas = {};
      return Cartographer.templates.get("areasSummary", function(e) {
        var area, key, _results;
        _results = [];
        for (key in Areas) {
          area = Areas[key];
          _this.areas[area.id] = area;
          _results.push(_this.areas[area.id]['areaSummary'] = new AreaSummary(_this.map, area, e, _this));
        }
        return _results;
      });
    };

    CustomMap.prototype.setAreasInformationVisibility = function(isVisible) {
      var box, _i, _len, _ref, _results;
      _ref = this.areaSummaryBoxes;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        box = _ref[_i];
        _results.push(box.setVisible(isVisible));
      }
      return _results;
    };

    CustomMap.prototype.toggleMarkersOptionsMenu = function() {
      return this.markersOptionsMenu.toggleClass('active');
    };

    CustomMap.prototype.hideMarkersOptionsMenu = function() {
      return this.markersOptionsMenu.addClass('off');
    };

    CustomMap.prototype.showMarkersOptionsMenu = function() {
      return this.markersOptionsMenu.removeClass('off');
    };

    return CustomMap;

  })();

  /*
  # }}}
  */


  /*
  # class AreaSummary {{{
  #
  */


  AreaSummary = (function() {

    function AreaSummary(map, area, template, carto) {
      var myIcon, northEast, popupContent, southWest, stringPopupContent,
        _this = this;
      southWest = new L.LatLng(area.swLat, area.swLng);
      northEast = new L.LatLng(area.neLat, area.neLng);
      this.bounds = new L.LatLngBounds(southWest, northEast);
      this.map = map;
      this.carto = carto;
      this.areaInfo = area;
      this.defaultStyle = {
        color: "black",
        weight: 4,
        fill: true,
        fillOpacity: 0.5
      };
      this.activeStyle = {
        color: "black",
        weight: 4,
        fill: false
      };
      this.rect = new L.rectangle(this.bounds, this.defaultStyle).addTo(map);
      this.rect.on('click', function(e) {
        var t;
        map.fitBounds(_this.bounds);
        return t = setTimeout(function() {
          return map.setZoom(6);
        }, 500);
      });
      this.template = _.template(template);
      stringPopupContent = this.template(this.areaInfo);
      popupContent = $(stringPopupContent);
      popupContent.appendTo('html').hide();
      myIcon = new L.divIcon({
        className: 'area-summary',
        html: stringPopupContent,
        iconSize: new L.Point(popupContent.outerWidth(), popupContent.outerHeight())
      });
      this.area = new L.marker(this.bounds.getCenter(), {
        icon: myIcon
      });
      this.area.on('click', function(e) {
        return _this.setActive();
      });
      this.area.addTo(map);
      popupContent.remove();
    }

    AreaSummary.prototype.setActive = function(callback) {
      var t,
        _this = this;
      this.map.removeLayer(this.area);
      this.map.panTo(this.bounds.getCenter());
      return t = setTimeout(function() {
        _this.map.setZoom(6);
        _this.rect.setStyle(_this.activeStyle);
        _this.carto.showMarkerFromArea(_this.areaInfo.id);
        if (callback != null) {
          return callback();
        }
      }, 500);
    };

    AreaSummary.prototype.setInactive = function() {
      this.area.addTo(this.map);
      return this.rect.setStyle(this.defaultStyle);
    };

    return AreaSummary;

  })();

  /*
  # }}}
  */


  /*
  # class CustomInfoWindow {{{
  */


  CustomInfoWindow = (function() {

    function CustomInfoWindow(marker, content, opts) {
      this.handleSave = __bind(this.handleSave, this);

      this.toggleSection = __bind(this.toggleSection, this);

      var wrap;
      this.content = content;
      this.marker = marker;
      this.template = opts.template;
      this.map = marker.map;
      this.latLng = new L.LatLng(marker._latlng.lat, marker._latlng.lng);
      wrap = "<div class=\"customInfoWindow\">\n   <div class=\"padding\"></div>\n</div>";
      this.wrap = $(wrap);
      this.wrap.find('.padding').append(this.content);
      this.closeBtn = this.wrap.find('.close');
      this.isVisible = false;
      this.onSave = opts.onSave;
      this.deleteCalled = opts.deleteCalled;
      this.moveCalled = opts.moveCalled;
      this.setLatLng(this.latLng);
      this.currentContent = this.wrap.clone();
      this.setContent(this.currentContent[0]);
      this.map.openPopup(this);
      this.bindButton();
    }

    CustomInfoWindow.prototype = new L.popup({
      autoPanPadding: new L.Point(120, 120),
      offset: new L.Point(0, -6)
    });

    CustomInfoWindow.prototype.open = function() {
      return this.openOn(this.map);
    };

    CustomInfoWindow.prototype.bindButton = function() {
      var _this = this;
      this.currentContent.find('button').bind('click', this.handleSave);
      return this.currentContent.find('.iw-options-list .button').bind('click', function(e) {
        return _this.toggleSection(e);
      });
    };

    CustomInfoWindow.prototype.toggleSection = function(e) {
      var action, activeTab, defaultTab, mywrap, targetTab, this_;
      this_ = $(e.currentTarget);
      mywrap = this_.closest('.customInfoWindow');
      action = this_.attr('data-action');
      defaultTab = mywrap.find('.marker-desc');
      activeTab = mywrap.find('.toggling-tab.active');
      targetTab = mywrap.find("[data-target='" + action + "']");
      switch (action) {
        case "move":
        case "share":
        case "edit":
          mywrap.find('.iw-options-list .button').removeClass('active');
          if (targetTab.attr("data-target") === activeTab.attr("data-target")) {
            targetTab.removeClass('active');
            defaultTab.addClass('active');
            this._update();
          } else {
            this_.addClass('active');
            activeTab.removeClass('active');
            targetTab.addClass('active');
            defaultTab.removeClass('active');
            this._update();
          }
          break;
        case "delete":
          this.deleteCalled(this.marker);
      }
      if (action === "move") {
        return this.moveCalled(this.marker);
      }
    };

    CustomInfoWindow.prototype.handleSave = function(e) {
      var form, lang, newDesc, newInfo, newTitle, newWikiLink, this_;
      this_ = $(e.currentTarget);
      form = this.currentContent.find('.edit-form');
      newTitle = this.currentContent.find('[name="marker-title"]').val();
      newDesc = this.currentContent.find('[name="marker-description"]').val();
      newDesc = newDesc.replace(/\n/g, '<br />');
      newWikiLink = this.currentContent.find('[name="marker-wiki"]').val();
      form.removeClass('active');
      lang = window.LANG === "en" ? '#/' : "#/fr/";
      newInfo = {
        id: this.marker.uniqueID,
        title: newTitle,
        desc: newDesc,
        wikiLink: newWikiLink,
        type: this.marker.type,
        cat: this.marker.cat,
        lat: this.marker.getLatLng().lat,
        lng: this.marker.getLatLng().lng,
        shareLink: "http://" + window.location.hostname + "/" + lang + "show/" + this.marker.id_marker + "/",
        hasDefaultValue: this.marker["hasDefaultValue"]
      };
      this.wrap.find('.padding').html(this.template(newInfo));
      this.currentContent = this.wrap.clone();
      this.setContent(this.currentContent[0]);
      this.bindButton();
      this.currentContent.find('.edit').removeClass('active');
      this._update();
      return this.onSave(newInfo);
    };

    return CustomInfoWindow;

  })();

  /*
  # }}}
  */


  Cartographer.router = Backbone.Router.extend({
    routes: {},
    initialize: function() {
      var routes,
        _this = this;
      routes = [[/^\/*(en|fr)\/*$/, 'lang', this.handleLang], [/^\/*(en|fr)*\/*show\/([0-9]+)\/*$/, 'show', this.handleShow], [/^\/*(en|fr)*\/*info\/*$/, 'info', this.handleInfo]];
      _.each(routes, function(route) {
        return _this.route.apply(_this, route);
      });
      return Backbone.history.start();
    },
    handleLang: function(lang) {
      return Cartographer.switchLang(lang);
    },
    handleCat: function(lang, a) {
      if (lang != null) {
        this.handleLang(lang);
      }
      return Cartographer.toggleCat(a.split('&'));
    },
    handleShow: function(lang, id) {
      if (lang != null) {
        this.handleLang(lang);
      }
      return Cartographer.highlighMarker(id);
    },
    handleCoord: function(lang, lat, lng) {
      if (lang != null) {
        this.handleLang(lang);
      }
      return Cartographer.highlighMarker({
        lat: lat,
        lng: lng
      });
    },
    handleInfo: function(lang) {
      if (lang != null) {
        this.handleLang(lang);
      }
      return Cartographer.showInfo();
    }
  });

  $(function() {
    return Cartographer.initiate();
  });

}).call(this);
